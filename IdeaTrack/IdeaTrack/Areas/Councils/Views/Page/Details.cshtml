@model IdeaTrack.Areas.Councils.Models.GradingVM
@{
    ViewData["Title"] = "Evaluation";
    Layout = "~/Areas/Councils/Views/Shared/_LayoutCouncils.cshtml";
    var isViewOnly = ViewData["ViewOnlyMode"] as bool? ?? Model.IsLocked;
}

@section Styles {
<style>
    .eval-header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        margin: -2rem -2rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .eval-header .back-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .eval-header .back-btn:hover {
        background: var(--brand-light);
        color: var(--brand-primary);
        border-color: var(--brand-primary);
    }
    
    .eval-header .title-group h5 {
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
    }
    
    .eval-header .title-group .meta {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    
    .eval-header .badges {
        display: flex;
        gap: 0.5rem;
    }
    
    .badge-code {
        background: var(--brand-light);
        color: var(--brand-primary);
        font-weight: 600;
        font-size: 0.7rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
    }
    
    .badge-round {
        background: var(--brand-primary);
        color: white;
        font-weight: 600;
        font-size: 0.7rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
    }
    
    .badge-locked {
        background: #6b7280;
        color: white;
        font-weight: 600;
        font-size: 0.7rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
    }
    
    /* Split View */
    .eval-split {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 0;
        margin-top: 1.5rem;
        min-height: calc(100vh - 180px);
    }
    
    .eval-info-panel {
        background: var(--bg-main);
        padding: 1.5rem;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
    }
    
    .eval-form-panel {
        background: var(--bg-card);
        padding: 1.5rem 2rem;
        overflow-y: auto;
    }
    
    /* Info Cards */
    .info-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
    }
    
    .info-card h6 {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
    }
    
    .info-row {
        margin-bottom: 0.75rem;
    }
    
    .info-row label {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .info-row .value {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .author-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--brand-light);
        color: var(--brand-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Attachments */
    .attachment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg-main);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
    }
    
    .attachment-item .file-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        background: var(--danger-light);
        color: var(--danger);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .attachment-item .file-name {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Scoring Section */
    .scoring-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .scoring-header h4 {
        font-weight: 700;
        margin: 0;
    }
    
    .total-score-box {
        background: var(--bg-main);
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .total-score-box .label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    
    .total-score-box .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--brand-primary);
    }
    
    .total-score-box .max {
        color: var(--text-muted);
        font-weight: 400;
    }
    
    /* Criteria Table */
    .criteria-table {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .criteria-table table {
        margin: 0;
        width: 100%;
    }
    
    .criteria-table thead th {
        background: var(--bg-main);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
        padding: 0.875rem 1rem;
        border: none;
    }
    
    .criteria-table tbody td {
        padding: 1rem;
        vertical-align: top;
        border-bottom: 1px solid var(--border-color);
    }
    
    .criteria-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .criteria-table tbody tr:hover {
        background: #fafaff;
    }
    
    .criteria-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }
    
    .criteria-desc {
        font-size: 0.8rem;
        color: var(--text-muted);
        line-height: 1.4;
    }
    
    .score-input-group {
        display: flex;
        align-items: center;
    }
    
    .score-input-group input {
        width: 60px;
        text-align: center;
        font-weight: 600;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        padding: 0.5rem;
    }
    
    .score-input-group input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px rgba(190,18,60,0.1);
    }
    
    .score-input-group .max-badge {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-left: none;
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    
    .note-input {
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .note-input:focus {
        outline: none;
        border-color: var(--brand-primary);
    }
    
    /* Feedback Section */
    .feedback-section {
        margin-top: 2rem;
    }
    
    .feedback-section h5 {
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .feedback-box textarea {
        width: 100%;
        border: none;
        background: transparent;
        resize: none;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .feedback-box textarea:focus {
        outline: none;
    }
    
    /* Action Footer */
    .action-footer {
        position: sticky;
        bottom: 0;
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        padding: 1rem 2rem;
        margin: 2rem -2rem -1.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }
    
    .btn-save-draft {
        background: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-save-draft:hover {
        background: var(--bg-main);
        border-color: var(--text-muted);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-medium));
        color: white;
        border: none;
        padding: 0.75rem 1.75rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-submit:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(190,18,60,0.35);
        color: white;
    }
    
    @@media (max-width: 991px) {
        .eval-split {
            grid-template-columns: 1fr;
        }
        
        .eval-info-panel {
            border-right: none;
            border-bottom: 1px solid var(--border-color);
        }
    }
</style>
}

<div class="page-inner">
    <!-- Header -->
    <div class="eval-header">
        <div class="d-flex align-items-center gap-3">
            <a asp-action="AssignedInitiatives" class="back-btn">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="title-group">
                <h5>@Model.InitiativeTitle</h5>
                <span class="meta">@Model.ProposerName • @Model.DepartmentName</span>
            </div>
        </div>
        <div class="badges">
            <span class="badge-code">@Model.InitiativeCode</span>
            <span class="badge-round">Round @Model.RoundNumber</span>
            @if (isViewOnly)
            {
                <span class="badge-locked"><i class="bi bi-lock-fill me-1"></i>Locked</span>
            }
        </div>
    </div>

    <!-- Split View -->
    <div class="eval-split">
        <!-- Info Panel -->
        <div class="eval-info-panel">
            <div class="info-card">
                <h6><i class="bi bi-info-circle me-1"></i>Initiative Details</h6>
                
                <div class="info-row">
                    <label>Author</label>
                    @if (Model.HidePersonalInfo)
                    {
                         <div class="d-flex align-items-center gap-2">
                            <div class="author-avatar" style="background:var(--text-muted); color:white;">?</div>
                            <span class="value text-muted"><em>Hidden for Blind Review</em></span>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex align-items-center gap-2">
                            <div class="author-avatar">@Model.ProposerName.Substring(0,1).ToUpper()</div>
                            <span class="value">@Model.ProposerName</span>
                        </div>
                    }
                </div>
                
                <div class="info-row">
                    <label>Department</label>
                    @if (Model.HidePersonalInfo)
                    {
                        <span class="value text-muted"><em>Hidden</em></span>
                    }
                    else
                    {
                        <span class="value">@Model.DepartmentName</span>
                    }
                </div>
                
                @if (Model.DueDate.HasValue)
                {
                    <div class="info-row">
                        <label>Due Date</label>
                        <span class="value @(Model.DueDate.Value < DateTime.Now ? "text-danger" : "")">
                            @Model.DueDate.Value.ToString("MMMM dd, yyyy")
                        </span>
                    </div>
                }
            </div>
            
            <div class="info-card">
                <h6><i class="bi bi-file-text me-1"></i>Description</h6>
                <div style="font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary);">
                    @Html.Raw(Model.Description?.Replace("\n", "<br>") ?? "No description provided.")
                </div>
            </div>
            
            <div class="info-card">
                <h6><i class="bi bi-paperclip me-1"></i>Attachments</h6>
                @if (Model.Files != null && Model.Files.Any())
                {
                    @foreach (var f in Model.Files)
                    {
                        <div class="attachment-item">
                            <div class="d-flex align-items-center gap-3">
                                <div class="file-icon">
                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                </div>
                                <span class="file-name" title="@f.FileName">@f.FileName</span>
                            </div>
                            @{
                                var relativePath = f.FilePath.Replace("/uploads/initiatives/", "");
                            }
                            <a href="/Councils/ViewerPage?file=@Uri.EscapeDataString(relativePath)" target="_blank" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted small mb-0">No attachments</p>
                }
            </div>
        </div>

        <!-- Form Panel -->
        <div class="eval-form-panel">
            <form asp-area="Councils" asp-controller="Page" asp-action="SubmitGrading" method="post" id="gradingForm">
                <input type="hidden" asp-for="AssignmentId" />
                
                <div class="scoring-header">
                    <h4>Scoring & Feedback</h4>
                    <div class="total-score-box">
                        <span class="label">Total Score</span>
                        <span class="value" id="totalScore">0</span>
                        <span class="max">/ @Model.MaxTotalScore</span>
                    </div>
                </div>
                
                <!-- Criteria Table -->
                @if (Model.CriteriaItems != null)
                {
                    <div class="criteria-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 45%;">Criteria</th>
                                    <th style="width: 20%;">Score</th>
                                    <th style="width: 35%;">Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.CriteriaItems.Count; i++)
                                {
                                    var criterion = Model.CriteriaItems[i];
                                    <input type="hidden" name="CriteriaItems[@i].CriteriaId" value="@criterion.CriteriaId" />
                                    
                                    <tr>
                                        <td>
                                            <div class="criteria-name">@criterion.CriteriaName</div>
                                            <div class="criteria-desc">@criterion.Description</div>
                                        </td>
                                        <td>
                                            <div class="score-input-group">
                                                <input type="number" name="CriteriaItems[@i].ScoreGiven" 
                                                       class="score-input" 
                                                       min="0" max="@criterion.MaxScore" 
                                                       value="@criterion.ScoreGiven"
                                                       @(isViewOnly ? "readonly" : "") required />
                                                <span class="max-badge">/@criterion.MaxScore</span>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" name="CriteriaItems[@i].Note" 
                                                   class="note-input" 
                                                   value="@criterion.Note"
                                                   @(isViewOnly ? "readonly" : "") 
                                                   placeholder="Add note..." />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                
                <!-- Feedback Section -->
                <div class="feedback-section">
                    <h5>Detailed Assessment</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="feedback-box feedback-strengths h-100">
                                <h6><i class="bi bi-check-circle-fill"></i> Strengths</h6>
                                <textarea name="Strengths" rows="3" 
                                          @(isViewOnly ? "readonly" : "") 
                                          placeholder="What are the key strengths?">@Model.Strengths</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feedback-box feedback-limitations h-100">
                                <h6><i class="bi bi-exclamation-triangle-fill"></i> Limitations</h6>
                                <textarea name="Limitations" rows="3" 
                                          @(isViewOnly ? "readonly" : "") 
                                          placeholder="What are the limitations?">@Model.Limitations</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feedback-box feedback-recommendations">
                        <h6><i class="bi bi-lightbulb-fill"></i> Recommendations</h6>
                        <textarea name="Recommendations" rows="2" 
                                  @(isViewOnly ? "readonly" : "") 
                                  placeholder="Suggest improvements...">@Model.Recommendations</textarea>
                    </div>
                </div>
                
                <!-- Action Footer -->
                @if (!isViewOnly)
                {
                    <div class="action-footer">
                        <button type="submit" class="btn-save-draft">
                            <i class="bi bi-save me-2"></i>Save Draft
                        </button>
                        <button type="button" id="btnSubmitFinal" class="btn-submit">
                            <i class="bi bi-send-fill me-2"></i>Submit Final
                        </button>
                    </div>

                }
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ======= Hidden input để gửi action =======
        const gradingForm = document.getElementById('gradingForm');
        let hiddenActionInput = document.createElement('input');
        hiddenActionInput.type = 'hidden';
        hiddenActionInput.id = 'hiddenSubmitAction';
        hiddenActionInput.name = 'SubmitAction';
        hiddenActionInput.value = 'SaveDraft'; // mặc định là SaveDraft
        gradingForm.appendChild(hiddenActionInput);

        // ======= Submit Final Button =======
        document.getElementById('btnSubmitFinal').addEventListener('click', function () {
            calculateTotal();
            const total = Number(document.getElementById('totalScore').innerText);

            if (total <= 0) {
                showConfirmPopup("Total score must be greater than 0 before submitting.", null, true);
                return;
            }

            showConfirmPopup("Submit your evaluation? You cannot modify after submitting.", function () {
                // Set hidden input thành "Submit" trước khi gửi form
                hiddenActionInput.value = 'Submit';
                gradingForm.submit();
            });
        });

        // ======= Save Draft Buttons =======
        document.querySelectorAll('button[name="SubmitAction"][value="SaveDraft"]').forEach(btn => {
            btn.addEventListener('click', function () {
                hiddenActionInput.value = 'SaveDraft';
            });
        });

        // ======= Tính tổng điểm =======
              document.addEventListener('DOMContentLoaded', function () {
            calculateTotal();
        });

        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('score-input')) {
                calculateTotal();

                // Validation
                const max = parseFloat(e.target.getAttribute('max'));
                const val = parseFloat(e.target.value);
                if (val > max || val < 0) {
                    e.target.style.borderColor = 'var(--danger)';
                } else {
                    e.target.style.borderColor = 'var(--border-color)';
                }
            }
        });

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.score-input').forEach(input => {
                total += Number(input.value) || 0;
            });
            document.getElementById('totalScore').innerText = total.toFixed(1);
        }

        // ======= Popup xác nhận =======
        function showConfirmPopup(message, onConfirm = null, isWarning = false) {
            // Xóa popup cũ nếu có
            const old = document.getElementById('confirmPopup');
            if (old) old.remove();

            const popup = document.createElement('div');
            popup.id = 'confirmPopup';
            popup.innerHTML = `
                <div class="popup-overlay"></div>
                <div class="popup-box">
                    <div class="popup-content">
                        <i class="bi ${isWarning ? "bi-exclamation-triangle-fill" : "bi-send-fill"}"
                           style="font-size:1.8rem; color:white;
                           background: ${isWarning ? "#dc3545" : "linear-gradient(135deg, var(--brand-primary), var(--brand-medium))"};
                           border-radius:50%; padding:0.5rem;"></i>
                        <p style="margin-top:1rem;">${message}</p>
                        <div style="display:flex; justify-content:center; gap:0.75rem; margin-top:1.5rem;">
                            <button class="btn-cancel">Cancel</button>
                            ${!isWarning ? '<button class="btn-confirm">Submit</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);

            // Cancel
            popup.querySelector('.btn-cancel').addEventListener('click', () => popup.remove());

            // Confirm
            if (!isWarning && onConfirm) {
                popup.querySelector('.btn-confirm').addEventListener('click', () => {
                    onConfirm();
                    popup.remove();
                });
            }
        }

        // ======= Popup Styles =======
        const style = document.createElement('style');
        style.innerHTML = `
            .popup-overlay {
                position: fixed; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.4); z-index: 9998;
            }
            .popup-box {
                position: fixed; top:50%; left:50%; transform: translate(-50%, -50%);
                background: var(--bg-card); border-radius: var(--radius-md);
                padding: 2rem; max-width: 360px; width: 90%; z-index:9999;
                box-shadow:0 4px 20px rgba(0,0,0,0.25); text-align:center;
                animation: popupFade 0.3s ease-out;
            }
            .popup-content p { margin-top:1rem; font-weight:500; color: var(--text-primary);}
            .btn-cancel, .btn-confirm {
                padding:0.5rem 1.25rem; border-radius: var(--radius-sm); font-weight:600; cursor:pointer; border:none; transition:0.2s;
            }
            .btn-cancel { background: var(--bg-main); color: var(--text-primary); }
            .btn-cancel:hover { background: var(--border-color); }
            .btn-confirm { background: linear-gradient(135deg, var(--brand-primary), var(--brand-medium)); color:white; }
            .btn-confirm:hover { transform: translateY(-1px); box-shadow:0 4px 12px rgba(190,18,60,0.35); }

            @@keyframes popupFade {
                0% { opacity:0; transform: translate(-50%, -55%);}
                100% { opacity:1; transform: translate(-50%, -50%);}
            }
        `;
        document.head.appendChild(style);
    </script>
}

