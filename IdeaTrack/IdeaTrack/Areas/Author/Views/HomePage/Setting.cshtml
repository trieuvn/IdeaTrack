@model IdeaTrack.Areas.Author.ViewModels.SettingViewModel

<main class="container py-5">

    <!-- Toast Container for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <span class="material-icons align-middle me-2">check_circle</span>
                    <span id="toastMessage">Changes saved successfully!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <span class="material-icons align-middle me-2">error</span>
                    <span id="errorToastMessage">An error occurred!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero-section text-white p-5 mb-5 shadow-lg">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <span class="badge rounded-pill bg-white bg-opacity-25 mb-3 p-2 px-3">
                    <span class="material-icons align-middle me-1" style="font-size: 16px;">settings</span> ACCOUNT SETTINGS
                </span>
                <h1 class="fw-bold display-5 mb-3">Hello, <span id="displayFullName">@Model.FullName</span>!</h1>
                <p class="fs-5 mb-0 opacity-75">
                    Manage your personal information and customize your system settings.
                </p>
            </div>
            <div class="col-lg-4 d-none d-lg-flex justify-content-end">
                <div class="bg-white bg-opacity-15 rounded-circle p-4" style="backdrop-filter: blur(10px);">
                    @if (!string.IsNullOrEmpty(Model.AvatarUrl))
                    {
                        <img src="@Model.AvatarUrl" class="rounded-circle" width="100" height="100" alt="Avatar">
                    }
                    else
                    {
                        <span class="material-icons text-white" style="font-size: 100px;">account_circle</span>
                    }
                </div>
            </div>
        </div>
    </section>

    <div class="row g-4">

        <!-- Left Column: Profile Info -->
        <div class="col-lg-4">
            <div class="card card-custom shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-body text-center p-4">
                    <div class="mb-4">
                        @if (!string.IsNullOrEmpty(Model.AvatarUrl))
                        {
                            <img src="@Model.AvatarUrl" class="rounded-circle shadow" width="120" height="120" alt="Avatar">
                        }
                        else
                        {
                            <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle bg-danger bg-opacity-10" style="width: 120px; height: 120px;">
                                <span class="material-icons text-danger" style="font-size: 60px;">person</span>
                            </div>
                        }
                    </div>
                    <h4 class="fw-bold mb-1" id="profileFullName">@Model.FullName</h4>
                    <p class="text-muted mb-3" id="profilePosition">@(Model.Position ?? "Lecturer")</p>
                    
                    <div class="d-flex justify-content-center gap-2 mb-3" id="profileBadges">
                        @if (!string.IsNullOrEmpty(Model.AcademicRank))
                        {
                            <span class="badge bg-primary rounded-pill" id="badgeAcademicRank">@Model.AcademicRank</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.Degree))
                        {
                            <span class="badge bg-success rounded-pill" id="badgeDegree">@Model.Degree</span>
                        }
                    </div>

                    <hr>

                    <div class="text-start">
                        <div class="d-flex align-items-center mb-3">
                            <span class="material-icons text-muted me-3">email</span>
                            <div>
                                <div class="small text-muted">Email</div>
                                <div class="fw-medium">@Model.Email</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="material-icons text-muted me-3">business</span>
                            <div>
                                <div class="small text-muted">Department</div>
                                <div class="fw-medium">@(Model.Department ?? "Not updated")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Settings -->
        <div class="col-lg-8">
            
            <!-- Account Settings Card -->
            <div class="card card-custom shadow-sm mb-4" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">
                        <span class="material-icons align-middle me-2 text-primary">manage_accounts</span>
                        Account Settings
                    </h5>
                </div>
                <div class="card-body p-0">
                    
                    <!-- Personal Information -->
                    <div class="d-flex align-items-center justify-content-between p-4 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-light-blue me-3">
                                <span class="material-icons text-primary">person</span>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0">Personal Information</h6>
                                <small class="text-muted">Update full name, title, degree</small>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <span class="material-icons align-middle" style="font-size: 18px;">edit</span> Edit
                        </button>
                    </div>

                    <!-- Change Password -->
                    <div class="d-flex align-items-center justify-content-between p-4 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-light-yellow me-3">
                                <span class="material-icons text-warning">lock</span>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0">Change Password</h6>
                                <small class="text-muted">Update your login password</small>
                            </div>
                        </div>
                        <button class="btn btn-outline-warning rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <span class="material-icons align-middle" style="font-size: 18px;">vpn_key</span> Change
                        </button>
                    </div>

                    <!-- File Storage -->
                    <a asp-action="Files" class="d-flex align-items-center justify-content-between p-4 text-decoration-none text-dark">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-light-green me-3">
                                <span class="material-icons text-success">folder</span>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0">File Management</h6>
                                <small class="text-muted">View and manage uploaded files</small>
                            </div>
                        </div>
                        <span class="material-icons text-muted">chevron_right</span>
                    </a>

                </div>
            </div>

            <!-- Notification Settings Card -->
            <div class="card card-custom shadow-sm mb-4" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">
                        <span class="material-icons align-middle me-2 text-info">notifications</span>
                        Notification
                    </h5>
                </div>
                <div class="card-body p-0">
                    
                    <!-- System Notifications -->
                    <div class="d-flex align-items-center justify-content-between p-4 border-bottom">
                        <div class="d-flex align-items-center">
                            <span class="material-icons text-info me-3">notifications_active</span>
                            <div>
                                <h6 class="fw-bold mb-0">System Notifications</h6>
                                <small class="text-muted">Receive notifications for initiative updates</small>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitch" @(Model.NotificationsEnabled ? "checked" : "")>
                        </div>
                    </div>

                    <!-- Email Alerts -->
                    <div class="d-flex align-items-center justify-content-between p-4">
                        <div class="d-flex align-items-center">
                            <span class="material-icons text-danger me-3">email</span>
                            <div>
                                <h6 class="fw-bold mb-0">Email Notifications</h6>
                                <small class="text-muted">Receive email when initiative is approved/rejected</small>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="emailSwitch" @(Model.EmailAlertsEnabled ? "checked" : "")>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card border-danger shadow-sm" style="border-radius: 15px;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="material-icons text-danger me-3">logout</span>
                            <div>
                                <h6 class="fw-bold mb-0">Logout</h6>
                                <small class="text-muted">Sign out of current account</small>
                            </div>
                        </div>
                        <form asp-area="" asp-controller="Account" asp-action="Logout" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger rounded-pill px-4">
                                <span class="material-icons align-middle me-1" style="font-size: 18px;">power_settings_new</span> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>

</main>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                    <span class="material-icons align-middle me-2 text-primary">edit</span>
                    Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editFullName" value="@Model.FullName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" id="editPosition" value="@Model.Position" placeholder="e.g., Lecturer, Senior Lecturer">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Academic Rank</label>
                            <select class="form-select" id="editAcademicRank">
                                <option value="">-- Select --</option>
                                @if (Model.AcademicRank == "PGS")
                                {
                                    <option value="PGS" selected>PGS</option>
                                }
                                else
                                {
                                    <option value="PGS">PGS</option>
                                }
                                @if (Model.AcademicRank == "GS")
                                {
                                    <option value="GS" selected>GS</option>
                                }
                                else
                                {
                                    <option value="GS">GS</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Degree</label>
                            <select class="form-select" id="editDegree">
                                <option value="">-- Select --</option>
                                @if (Model.Degree == "ThS")
                                {
                                    <option value="ThS" selected>Thạc sĩ (ThS)</option>
                                }
                                else
                                {
                                    <option value="ThS">Thạc sĩ (ThS)</option>
                                }
                                @if (Model.Degree == "TS")
                                {
                                    <option value="TS" selected>Tiến sĩ (TS)</option>
                                }
                                else
                                {
                                    <option value="TS">Tiến sĩ (TS)</option>
                                }
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" id="btnSaveProfile" onclick="saveProfile()">
                    <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                    <span class="material-icons align-middle me-2 text-warning">vpn_key</span>
                    Change Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <small class="text-muted">Minimum 6 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                        <div class="invalid-feedback" id="passwordMatchError">Passwords do not match</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning rounded-pill px-4" id="btnChangePassword" onclick="changePassword()">
                    <span class="spinner-border spinner-border-sm d-none" id="passwordSpinner"></span>
                    Change Password
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Save Profile function with AJAX
    function saveProfile() {
        var fullName = document.getElementById('editFullName').value.trim();
        var position = document.getElementById('editPosition').value.trim();
        var academicRank = document.getElementById('editAcademicRank').value;
        var degree = document.getElementById('editDegree').value;

        if (!fullName) {
            showError('Full name is required');
            return;
        }

        // Show spinner
        document.getElementById('saveSpinner').classList.remove('d-none');
        document.getElementById('btnSaveProfile').disabled = true;

        fetch('@Url.Action("UpdateProfile", "HomePage", new { area = "Author" })', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({
                fullName: fullName,
                position: position,
                academicRank: academicRank,
                degree: degree
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('saveSpinner').classList.add('d-none');
            document.getElementById('btnSaveProfile').disabled = false;

            if (data.success) {
                // Update UI without reload
                document.getElementById('displayFullName').textContent = fullName;
                document.getElementById('profileFullName').textContent = fullName;
                document.getElementById('profilePosition').textContent = position || 'Lecturer';
                
                // Update badges
                var badgesContainer = document.getElementById('profileBadges');
                badgesContainer.innerHTML = '';
                if (academicRank) {
                    badgesContainer.innerHTML += '<span class="badge bg-primary rounded-pill">' + academicRank + '</span>';
                }
                if (degree) {
                    badgesContainer.innerHTML += '<span class="badge bg-success rounded-pill">' + degree + '</span>';
                }

                // Close modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                modal.hide();

                // Show success toast
                showSuccess('Profile updated successfully!');
            } else {
                showError(data.message || 'Failed to update profile');
            }
        })
        .catch(error => {
            document.getElementById('saveSpinner').classList.add('d-none');
            document.getElementById('btnSaveProfile').disabled = false;
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        });
    }

    // Change Password function with AJAX
    function changePassword() {
        var currentPassword = document.getElementById('currentPassword').value;
        var newPassword = document.getElementById('newPassword').value;
        var confirmPassword = document.getElementById('confirmPassword').value;

        // Validation
        if (!currentPassword || !newPassword || !confirmPassword) {
            showError('All fields are required');
            return;
        }

        if (newPassword.length < 6) {
            showError('New password must be at least 6 characters');
            return;
        }

        if (newPassword !== confirmPassword) {
            document.getElementById('confirmPassword').classList.add('is-invalid');
            return;
        }

        document.getElementById('confirmPassword').classList.remove('is-invalid');

        // Show spinner
        document.getElementById('passwordSpinner').classList.remove('d-none');
        document.getElementById('btnChangePassword').disabled = true;

        fetch('@Url.Action("ChangePassword", "HomePage", new { area = "Author" })', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('passwordSpinner').classList.add('d-none');
            document.getElementById('btnChangePassword').disabled = false;

            if (data.success) {
                // Clear form
                document.getElementById('changePasswordForm').reset();
                
                // Close modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();

                // Show success toast
                showSuccess('Password changed successfully!');
            } else {
                showError(data.message || 'Failed to change password');
            }
        })
        .catch(error => {
            document.getElementById('passwordSpinner').classList.add('d-none');
            document.getElementById('btnChangePassword').disabled = false;
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        });
    }

    // Toast notification functions
    function showSuccess(message) {
        document.getElementById('toastMessage').textContent = message;
        var toast = new bootstrap.Toast(document.getElementById('successToast'));
        toast.show();
    }

    function showError(message) {
        document.getElementById('errorToastMessage').textContent = message;
        var toast = new bootstrap.Toast(document.getElementById('errorToast'));
        toast.show();
    }
</script>
}
