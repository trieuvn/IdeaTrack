@model IEnumerable<IdeaTrack.Areas.SciTech.Models.UserViewModel>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-4">
        <div>
            <h1 class="fw-bold mb-1">Quản lý Người dùng & Truy cập</h1>
            <p class="text-muted mb-0">
                Quản lý tài khoản, phân quyền và theo dõi hoạt động truy cập hệ thống.
            </p>
        </div>
        <a class="btn btn-outline-primary custom-btn" style="height:70px;padding-top:20px;"
           href="@Url.Action("ExportExcelUser", "Port", new {
                keyword = ViewBag.Keyword,
                role = ViewBag.Role,
                status = ViewBag.Status
           })">
    <i class="fa-solid fa-file-export me-1"></i>Xuất báo cáo
</a>

    </div>

    <!-- STATS -->
    <div class="row g-4 mb-4">

        <!-- Tổng người dùng -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-users text-primary fs-4"></i>
                    <p class="text-muted small mb-1">Tổng người dùng</p>
                    <h3 class="fw-bold mb-0">@ViewBag.TotalUsers</h3>
                    <small class="text-success">
                        <i class="fa-solid fa-arrow-up"></i>
                        Hoạt động hệ thống
                    </small>
                </div>
            </div>
        </div>

        <!-- Đang hoạt động -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-circle-check text-success fs-4"></i>
                    <p class="text-muted small mb-1">Đang hoạt động</p>
                    <h3 class="fw-bold mb-0">@ViewBag.ActivePercent%</h3>
                    <small class="text-muted">
                        @ViewBag.ActiveUsers tài khoản
                    </small>
                </div>
            </div>
        </div>

        <!-- Đăng nhập gần đây -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-right-to-bracket text-info fs-4"></i>
                    <p class="text-muted small mb-1">Đăng nhập gần đây</p>
                    <h3 class="fw-bold mb-0">@ViewBag.RecentLogins</h3>
                    <small class="text-muted">24 giờ qua</small>
                </div>
            </div>
        </div>

        <!-- Chờ duyệt -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-clock text-warning fs-4"></i>
                    <p class="text-muted small mb-1">Chờ duyệt</p>
                    <h3 class="fw-bold mb-0">@ViewBag.PendingUsers</h3>
                    <small class="text-muted">Tài khoản</small>
                </div>
            </div>
        </div>

    </div>

    <!-- TOOLBAR -->
    <form method="get" class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">

            <!-- Search input -->
            <div class="flex-grow-1" style="min-width: 200px;">
                <div class="input-group">
                    <span class="input-group-text bg-white">
                        <i class="fa-solid fa-search"></i>
                    </span>
                    <input class="form-control"
                           name="keyword"
                           value="@ViewBag.Keyword"
                           placeholder="Tìm theo tên hoặc email">
                </div>
            </div>

            <!-- Role select -->
            <div style="min-width: 150px;">
                <select class="form-select" name="role">
                    <option value="">Tất cả vai trò</option>
                    @foreach (var r in ViewBag.Roles as List<string>)
                    {
                        <option value="@r" selected="@(ViewBag.Role == r)">
                            @r
                        </option>
                    }
                </select>
            </div>

            <!-- Status select -->
            <div style="min-width: 150px;">
                <select class="form-select" name="status">
                    <option value="">Tất cả trạng thái</option>
                    <option value="active" selected="@(ViewBag.Status == "active")">Hoạt động</option>
                    <option value="locked" selected="@(ViewBag.Status == "locked")">Đã khóa</option>
                    <option value="pending" selected="@(ViewBag.Status == "pending")">Chờ duyệt</option>
                </select>
            </div>

            <!-- Filter button -->
            <button type="submit" class="btn btn-outline-primary d-flex align-items-center">
                <i class="fa-solid fa-filter me-1"></i>Lọc
            </button>

            <!-- Add user -->
            <a href="#" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#createUserModal">
    <i class="fa-solid fa-user-plus me-1"></i> Thêm người dùng
</a>

        </div>
    </form>



    <!-- TABLE -->
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Người dùng</th>
                        <th>Vai trò</th>
                        <th>Trạng thái</th>
                        <th>Đăng nhập cuối</th>
                        <th class="text-center">Lượt truy cập</th>
                        <th class="text-end">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>
                                <div class="fw-semibold">@user.FullName</div>
                                <small class="text-muted">@user.Email</small>
                            </td>

                            <td>
                                <span class="badge bg-primary-subtle text-primary">
                                    @user.Role
                                </span>
                            </td>

                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge bg-success">Hoạt động</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Đã khóa</span>
                                }
                            </td>

                            <td>
                                @(user.LastActive?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa đăng nhập")
                            </td>

                            <td class="text-center fw-semibold">
                                @user.LoginCount
                            </td>

                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="openUserModal(@user.Id)">
                                     <i class="fa-solid fa-eye"></i>
                                </button>

                                @if (user.IsActive)
                                {
                                   <a href="@Url.Action("LockUser", "Port", new { area = "SciTech", id = user.Id })"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Bạn có chắc chắn muốn khóa tài khoản này?');">
                                        <i class="fa-solid fa-user-slash"></i>
                                    </a>
                                }
                                else
                                {
                                   <a href="@Url.Action("UnlockUser","Port", new { area = "SciTech", id = user.Id })"
                                       class="btn btn-sm btn-outline-success">
                                        <i class="fa-solid fa-unlock"></i>
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- PAGINATION -->
        <div class="card-footer d-flex justify-content-between align-items-center">

            <small class="text-muted">
                Hiển thị @ViewBag.From–@ViewBag.To / @ViewBag.TotalUsers người dùng
            </small>

            <nav>
                <ul class="pagination pagination-sm mb-0">

                    <!-- Previous -->
                    <li class="page-item @(ViewBag.Page == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(ViewBag.Page - 1)&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                            ‹
                        </a>
                    </li>

                    <!-- Page numbers -->
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                            <a class="page-link"
                               href="?page=@i&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                                @i
                            </a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(ViewBag.Page == ViewBag.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(ViewBag.Page + 1)&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                            ›
                        </a>
                    </li>

                </ul>
            </nav>
        </div>

    </div>

<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <div class="modal-content">
            <form action="@Url.Action("CreateUser", "Port", new { area = "SciTech" })" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createUserModalLabel">Thêm người dùng mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên đăng nhập</label>
                                <input name="UserName" class="form-control" placeholder="Nhập tên đăng nhập..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Địa chỉ Email</label>
                                <input name="Email" class="form-control" type="email" placeholder="vi-du@email.com" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Họ và tên</label>
                                <input name="FullName" class="form-control" placeholder="Nhập họ tên đầy đủ..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Mật khẩu hệ thống</label>
                                <input name="Password" class="form-control" type="password" placeholder="Mật khẩu (VD: Abc@123)" required />
                                <small class="text-muted small">Tối thiểu 6 ký tự, có chữ hoa, số và ký tự đặc biệt.</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Thuộc Khoa/Phòng</label>
                                <select name="DepartmentId" id="DepartmentId" class="form-select" required>
                                    <option value="">-- Chọn khoa/phòng --</option>
                                    @if (ViewBag.Departments != null)
                                    {
                                        foreach (var item in (SelectList)ViewBag.Departments)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Học hàm</label>
                                <select name="AcademicRank" class="form-select">
                                    <option value="">-- Chọn học hàm --</option>
                                    <option value="Giáo sư">Giáo sư</option>
                                    <option value="Phó giáo sư">Phó giáo sư</option>
                                    <option value="Không">Không</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Học vị</label>
                                <select name="Degree" class="form-select">
                                    <option value="">-- Chọn học vị --</option>
                                    <option value="Tiến sĩ">Tiến sĩ</option>
                                    <option value="Thạc sĩ">Thạc sĩ</option>
                                    <option value="Cử nhân">Cử nhân</option>
                                    <option value="Kỹ sư">Kỹ sư</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Chức vụ</label>
                                <input name="Position" class="form-control" placeholder="Ví dụ: Trưởng phòng, Giảng viên..." />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-user-plus me-1"></i> Xác nhận thêm
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="userInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thông tin chi tiết</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
         <img id="displayAvatar" 
     src="/images/default-avatar.png" 
     onerror="this.src='/images/default-avatar.png';" 
     class="rounded-circle img-thumbnail" 
     style="width: 120px; height: 120px; object-fit: cover;">
          <h4 id="displayFullName" class="mt-2 mb-0">Họ và tên</h4>
          <span id="displayIsActive" class="badge rounded-pill mt-1">Trạng thái</span>
        </div>

        <div class="row g-3">
          <div class="col-6">
            <label class="text-muted mb-0">Học hàm</label>
            <p id="displayAcademicRank" class="fw-bold text-primary">-</p>
          </div>
          <div class="col-6">
            <label class="text-muted mb-0">Học vị</label>
            <p id="displayDegree" class="fw-bold text-primary">-</p>
          </div>
          <div class="col-12">
            <label class="text-muted mb-0">Phòng ban / Khoa</label>
            <p id="displayDepartment" class="fw-bold">-</p>
          </div>
          <div class="col-12">
            <label class="text-muted mb-0">Chức vụ</label>
            <p id="displayPosition" class="fw-bold">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
    function openUserModal(userId) {
    // Đường dẫn trỏ tới Action 'GetUserDetail' trong cùng Controller
    // ASP.NET Core sẽ hiểu đây là: /TenController/GetUserDetail?id=...
    fetch(`./GetUserDetail?id=${userId}`) 
        .then(response => {
            if (!response.ok) throw new Error("Lỗi mạng hoặc không tìm thấy User");
            return response.json();
        })
        .then(data => {
            // Đổ dữ liệu vào Modal
            document.getElementById('displayFullName').innerText = data.fullName;
            document.getElementById('displayAcademicRank').innerText = data.academicRank || "-";
            document.getElementById('displayDegree').innerText = data.degree || "-";
            document.getElementById('displayDepartment').innerText = data.departmentName;
            document.getElementById('displayPosition').innerText = data.position || "-";

            // Xử lý ảnh Base64
            const imgElement = document.getElementById('displayAvatar');
            if (data.avatarUrl) {
                // Nếu chuỗi base64 trong DB chưa có tiền tố thì cộng thêm vào
                imgElement.src = data.avatarUrl.includes('base64,') 
                                 ? data.avatarUrl 
                                 : 'data:image/png;base64,' + data.avatarUrl;
            } else {
                imgElement.src = '/images/default-avatar.png';
            }

            // Trạng thái
            const badge = document.getElementById('displayIsActive');
            badge.innerText = data.isActive ? "Đang hoạt động" : "Ngừng hoạt động";
            badge.className = `badge rounded-pill mt-1 ${data.isActive ? 'bg-success' : 'bg-danger'}`;

            // Hiển thị Modal
            var myModal = new bootstrap.Modal(document.getElementById('userInfoModal'));
            myModal.show();
        })
        .catch(error => console.error('Lỗi:', error));
}
</script>