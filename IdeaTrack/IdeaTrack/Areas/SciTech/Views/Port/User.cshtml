@model IEnumerable<IdeaTrack.Areas.SciTech.Models.UserViewModel>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-4">
        <div>
            <h1 class="fw-bold mb-1">Qu?n lý Ngu?i dùng & Truy c?p</h1>
            <p class="text-muted mb-0">
                Qu?n lý tài kho?n, phân quy?n và theo dõi ho?t d?ng truy c?p h? th?ng.
            </p>
        </div>
        <a class="btn btn-outline-primary custom-btn" style="height:70px;padding-top:20px;"
           href="@Url.Action("ExportExcelUser", "Port", new {
                keyword = ViewBag.Keyword,
                role = ViewBag.Role,
                status = ViewBag.Status
           })">
    <i class="fa-solid fa-file-export me-1"></i>Xu?t báo cáo
</a>

    </div>

    <!-- STATS -->
    <div class="row g-4 mb-4">

        <!-- T?ng ngu?i dùng -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-users text-primary fs-4"></i>
                    <p class="text-muted small mb-1">T?ng ngu?i dùng</p>
                    <h3 class="fw-bold mb-0">@ViewBag.TotalUsers</h3>
                    <small class="text-success">
                        <i class="fa-solid fa-arrow-up"></i>
                        Ho?t d?ng h? th?ng
                    </small>
                </div>
            </div>
        </div>

        <!-- Ðang ho?t d?ng -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-circle-check text-success fs-4"></i>
                    <p class="text-muted small mb-1">Ðang ho?t d?ng</p>
                    <h3 class="fw-bold mb-0">@ViewBag.ActivePercent%</h3>
                    <small class="text-muted">
                        @ViewBag.ActiveUsers tài kho?n
                    </small>
                </div>
            </div>
        </div>

        <!-- Ðang nh?p g?n dây -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-right-to-bracket text-info fs-4"></i>
                    <p class="text-muted small mb-1">Ðang nh?p g?n dây</p>
                    <h3 class="fw-bold mb-0">@ViewBag.RecentLogins</h3>
                    <small class="text-muted">24 gi? qua</small>
                </div>
            </div>
        </div>

        <!-- Ch? duy?t -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <i class="fa-solid fa-clock text-warning fs-4"></i>
                    <p class="text-muted small mb-1">Ch? duy?t</p>
                    <h3 class="fw-bold mb-0">@ViewBag.PendingUsers</h3>
                    <small class="text-muted">Tài kho?n</small>
                </div>
            </div>
        </div>

    </div>

    <!-- TOOLBAR -->
    <form method="get" class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">

            <!-- Search input -->
            <div class="flex-grow-1" style="min-width: 200px;">
                <div class="input-group">
                    <span class="input-group-text bg-white">
                        <i class="fa-solid fa-search"></i>
                    </span>
                    <input class="form-control"
                           name="keyword"
                           value="@ViewBag.Keyword"
                           placeholder="Tìm theo tên ho?c email">
                </div>
            </div>

            <!-- Role select -->
            <div style="min-width: 150px;">
                <select class="form-select" name="role">
                    <option value="">T?t c? vai trò</option>
                    @foreach (var r in ViewBag.Roles as List<string>)
                    {
                        <option value="@r" selected="@(ViewBag.Role == r)">
                            @r
                        </option>
                    }
                </select>
            </div>

            <!-- Status select -->
            <div style="min-width: 150px;">
                <select class="form-select" name="status">
                    <option value="">T?t c? tr?ng thái</option>
                    <option value="active" selected="@(ViewBag.Status == "active")">Ho?t d?ng</option>
                    <option value="locked" selected="@(ViewBag.Status == "locked")">Ðã khóa</option>
                    <option value="pending" selected="@(ViewBag.Status == "pending")">Ch? duy?t</option>
                </select>
            </div>

            <!-- Filter button -->
            <button type="submit" class="btn btn-outline-primary d-flex align-items-center">
                <i class="fa-solid fa-filter me-1"></i>L?c
            </button>

            <!-- Add user -->
            <a href="#" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#createUserModal">
    <i class="fa-solid fa-user-plus me-1"></i> Thêm ngu?i dùng
</a>

        </div>
    </form>



    <!-- TABLE -->
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Ngu?i dùng</th>
                        <th>Vai trò</th>
                        <th>Tr?ng thái</th>
                        <th>Ðang nh?p cu?i</th>
                        <th class="text-center">Lu?t truy c?p</th>
                        <th class="text-end">Hành d?ng</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>
                                <div class="fw-semibold">@user.FullName</div>
                                <small class="text-muted">@user.Email</small>
                            </td>

                            <td>
                                <span class="badge bg-primary-subtle text-primary">
                                    @user.Role
                                </span>
                            </td>

                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge bg-success">Ho?t d?ng</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Ðã khóa</span>
                                }
                            </td>

                            <td>
                                @(user.LastActive?.ToString("dd/MM/yyyy HH:mm") ?? "Chua dang nh?p")
                            </td>

                            <td class="text-center fw-semibold">
                                @user.LoginCount
                            </td>

                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="openUserModal(@user.Id)">
                                     <i class="fa-solid fa-eye"></i>
                                </button>

                                @if (user.IsActive)
                                {
                                   <a href="@Url.Action("LockUser", "Port", new { area = "SciTech", id = user.Id })"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('B?n có ch?c ch?n mu?n khóa tài kho?n này?');">
                                        <i class="fa-solid fa-user-slash"></i>
                                    </a>
                                }
                                else
                                {
                                   <a href="@Url.Action("UnlockUser","Port", new { area = "SciTech", id = user.Id })"
                                       class="btn btn-sm btn-outline-success">
                                        <i class="fa-solid fa-unlock"></i>
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- PAGINATION -->
        <div class="card-footer d-flex justify-content-between align-items-center">

            <small class="text-muted">
                Hi?n th? @ViewBag.From–@ViewBag.To / @ViewBag.TotalUsers ngu?i dùng
            </small>

            <nav>
                <ul class="pagination pagination-sm mb-0">

                    <!-- Previous -->
                    <li class="page-item @(ViewBag.Page == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(ViewBag.Page - 1)&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                            ‹
                        </a>
                    </li>

                    <!-- Page numbers -->
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                            <a class="page-link"
                               href="?page=@i&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                                @i
                            </a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(ViewBag.Page == ViewBag.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(ViewBag.Page + 1)&keyword=@ViewBag.Keyword&role=@ViewBag.Role&status=@ViewBag.Status">
                            ›
                        </a>
                    </li>

                </ul>
            </nav>
        </div>

    </div>

<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <div class="modal-content">
            <form action="@Url.Action("CreateUser", "Port", new { area = "SciTech" })" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createUserModalLabel">Thêm ngu?i dùng m?i</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên dang nh?p</label>
                                <input name="UserName" class="form-control" placeholder="Nh?p tên dang nh?p..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ð?a ch? Email</label>
                                <input name="Email" class="form-control" type="email" placeholder="vi-du@email.com" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">H? và tên</label>
                                <input name="FullName" class="form-control" placeholder="Nh?p h? tên d?y d?..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">M?t kh?u h? th?ng</label>
                                <input name="Password" class="form-control" type="password" placeholder="M?t kh?u (VD: Abc@123)" required />
                                <small class="text-muted small">T?i thi?u 6 ký t?, có ch? hoa, s? và ký t? d?c bi?t.</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Thu?c Khoa/Phòng</label>
                                <select name="DepartmentId" id="DepartmentId" class="form-select" required>
                                    <option value="">-- Ch?n khoa/phòng --</option>
                                    @if (ViewBag.Departments != null)
                                    {
                                        foreach (var item in (SelectList)ViewBag.Departments)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">H?c hàm</label>
                                <select name="AcademicRank" class="form-select">
                                    <option value="">-- Ch?n h?c hàm --</option>
                                    <option value="Giáo su">Giáo su</option>
                                    <option value="Phó giáo su">Phó giáo su</option>
                                    <option value="Không">Không</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">H?c v?</label>
                                <select name="Degree" class="form-select">
                                    <option value="">-- Ch?n h?c v? --</option>
                                    <option value="Ti?n si">Ti?n si</option>
                                    <option value="Th?c si">Th?c si</option>
                                    <option value="C? nhân">C? nhân</option>
                                    <option value="K? su">K? su</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ch?c v?</label>
                                <input name="Position" class="form-control" placeholder="Ví d?: Tru?ng phòng, Gi?ng viên..." />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H?y</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-user-plus me-1"></i> Xác nh?n thêm
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="userInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thông tin chi ti?t</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
         <img id="displayAvatar" 
     src="/images/default-avatar.png" 
     onerror="this.src='/images/default-avatar.png';" 
     class="rounded-circle img-thumbnail" 
     style="width: 120px; height: 120px; object-fit: cover;">
          <h4 id="displayFullName" class="mt-2 mb-0">H? và tên</h4>
          <span id="displayIsActive" class="badge rounded-pill mt-1">Tr?ng thái</span>
        </div>

        <div class="row g-3">
          <div class="col-6">
            <label class="text-muted mb-0">H?c hàm</label>
            <p id="displayAcademicRank" class="fw-bold text-primary">-</p>
          </div>
          <div class="col-6">
            <label class="text-muted mb-0">H?c v?</label>
            <p id="displayDegree" class="fw-bold text-primary">-</p>
          </div>
          <div class="col-12">
            <label class="text-muted mb-0">Phòng ban / Khoa</label>
            <p id="displayDepartment" class="fw-bold">-</p>
          </div>
          <div class="col-12">
            <label class="text-muted mb-0">Ch?c v?</label>
            <p id="displayPosition" class="fw-bold">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
    function openUserModal(userId) {
    // Ðu?ng d?n tr? t?i Action 'GetUserDetail' trong cùng Controller
    // ASP.NET Core s? hi?u dây là: /TenController/GetUserDetail?id=...
    fetch(`./GetUserDetail?id=${userId}`) 
        .then(response => {
            if (!response.ok) throw new Error("L?i m?ng ho?c không tìm th?y User");
            return response.json();
        })
        .then(data => {
            // Ð? d? li?u vào Modal
            document.getElementById('displayFullName').innerText = data.fullName;
            document.getElementById('displayAcademicRank').innerText = data.academicRank || "-";
            document.getElementById('displayDegree').innerText = data.degree || "-";
            document.getElementById('displayDepartment').innerText = data.departmentName;
            document.getElementById('displayPosition').innerText = data.position || "-";

            // X? lý ?nh Base64
            const imgElement = document.getElementById('displayAvatar');
            if (data.avatarUrl) {
                // N?u chu?i base64 trong DB chua có ti?n t? thì c?ng thêm vào
                imgElement.src = data.avatarUrl.includes('base64,') 
                                 ? data.avatarUrl 
                                 : 'data:image/png;base64,' + data.avatarUrl;
            } else {
                imgElement.src = '/images/default-avatar.png';
            }

            // Tr?ng thái
            const badge = document.getElementById('displayIsActive');
            badge.innerText = data.isActive ? "Ðang ho?t d?ng" : "Ng?ng ho?t d?ng";
            badge.className = `badge rounded-pill mt-1 ${data.isActive ? 'bg-success' : 'bg-danger'}`;

            // Hi?n th? Modal
            var myModal = new bootstrap.Modal(document.getElementById('userInfoModal'));
            myModal.show();
        })
        .catch(error => console.error('L?i:', error));
}
</script>
