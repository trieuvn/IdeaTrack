@using IdeaTrack.Models
@model List<EvaluationCriteria>

<style>
    .btn-primary-custom {
        background-color: #b91c1c;
        color: white;
        border: none;
        transition: all 0.2s;
    }

        .btn-primary-custom:hover {
            background-color: #991b1b;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.2);
        }
        
    .text-brand {
        color: #b91c1c !important;
    }
</style>

<div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
        <div>
            <h2 class="fw-bold mb-1">Criteria & Weight Management</h2>
            <p class="text-muted mb-0">
                Define the scoring criteria and their weights. Total score is flexible.
            </p>
        </div>
    </div>
</div>

<!-- SUMMARY -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <small class="text-muted text-uppercase">Total Criteria</small>
                <h3 class="fw-bold mb-0" id="totalCriteria">0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Total Weight</small>
                    <span class="badge bg-success" id="weightStatus">Valid</span>
                </div>
                <h3 class="fw-bold text-success mb-0">
                    <span id="totalWeight">0</span>%
                </h3>
                <div class="progress mt-2" style="height:6px">
                    <div id="weightProgress" class="progress-bar bg-success" style="width:0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <small class="text-muted">Last Updated</small>
                <h6 class="fw-bold mb-0">@DateTime.Now.ToString("HH:mm - dd/MM/yyyy")</h6>
                <small class="text-muted">by Admin</small>
            </div>
        </div>
    </div>
</div>

<!-- ACTION -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">Criteria List</h5>
    <button type="button" class="btn btn-primary-custom" onclick="addCriteriaRow()">
        <i class="fa-solid fa-circle-plus me-1"></i>Add Criteria
    </button>
</div>

<form asp-area="SciTech" asp-controller="Template" asp-action="Rule" method="post" id="ruleForm">
    <!-- TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Criteria Name</th>
                        <th>Description</th>
                        <th style="width:30%">Weight (%)</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="criteriaTable">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @* Use name with ID for Controller Dictionary binding *@
                                <input class="form-control form-control-sm"
                                       name="criteria[@item.Id].CriteriaName"
                                       value="@item.CriteriaName" />
                            </td>
                            <td>
                                <input class="form-control form-control-sm"
                                       name="criteria[@item.Id].Description"
                                       value="@item.Description" />
                            </td>
                            <td>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-brand fw-bold">
                                        <span class="weight-label">@item.MaxScore.ToString("F2")</span>%
                                    </span>
                                    <input type="number" lang="en-US"
                                           class="form-control form-control-sm text-center weight-input"
                                           style="width:70px"
                                           name="criteria[@item.Id].MaxScore"
                                           value="@item.MaxScore.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                           min="0" max="100" step="0.01"
                                           oninput="syncWeight(this)" />
                                </div>
                                <input type="range" min="0" max="100" step="0.01"
                                       value="@item.MaxScore.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                       class="form-range weight-range"
                                       oninput="syncRange(this)" />
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer d-flex justify-content-between">
            <small class="text-muted">
                Showing <span id="countRow">0</span> criteria
            </small>
            <a href="#" class="fw-semibold text-decoration-none text-brand">Restore Default</a>
        </div>
    </div>

    <!-- PREVIEW -->
    <div class="alert alert-secondary">
        <i class="fa-solid fa-eye me-1"></i>
        <span class="fw-bold">Scoring Formula:</span>
        <span id="previewFormula"></span>
    </div>

    <!-- FOOTER ACTION -->
    <div class="d-flex justify-content-end gap-3">
        <a href="@Url.Action("Index", "Template", new { area = "SciTech" })" class="btn btn-outline-secondary">Back</a>
        <button type="submit" class="btn btn-primary-custom">
            <i class="fa-solid fa-floppy-disk me-1"></i>Save Changes
        </button>
    </div>
</form>

<script>
    let rowIndex = @Model.Count;

    /* =========================
       UTILITY: CLAMP
    ========================== */
    function clamp(value) {
        value = Number(value || 0);
        if (value < 0) return 0;
        if (value > 100) return 100;
        return Number(value.toFixed(2)); // 2 decimal places
    }

    /* =========================
       SYNC INPUT <-> RANGE
    ========================== */
    function syncWeight(input) {
        const td = input.closest("td");
        const range = td.querySelector(".weight-range");
        const label = td.querySelector(".weight-label");

        // If user clears the input, treat as 0
        let val = input.value.replace(',', '.');
        let value = Number(val || 0);

        // Cap at 100 immediately
        if (value > 100) {
            value = 100;
            input.value = 100;
        }

        if (range) range.value = value;
        if (label) label.innerText = value.toFixed(2);

        updateSummary();
    }

    function syncRange(range) {
        const td = range.closest("td");
        const input = td.querySelector(".weight-input");
        const label = td.querySelector(".weight-label");
        const value = clamp(range.value);

        if (input) input.value = value;
        if (label) label.innerText = value.toFixed(2);

        updateSummary();
    }

    /* =========================
       ADD / REMOVE ROW
    ========================== */
    function addCriteriaRow() {
        rowIndex++;
        // Use a negative ID or special marker for new items if needed by controller
        // For now using rowIndex as a temporary key
        const newId = -rowIndex; 
        
        const html = `
            <tr>
                <td>
                    <input class="form-control form-control-sm" name="criteria[${newId}].CriteriaName" placeholder="New Criteria" />
                </td>
                <td>
                    <input class="form-control form-control-sm" name="criteria[${newId}].Description" placeholder="Description" />
                </td>
                <td>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-brand fw-bold">
                            <span class="weight-label">0.00</span>%
                        </span>
                        <input type="number" lang="en-US" class="form-control form-control-sm text-center weight-input"
                               style="width:70px" name="criteria[${newId}].MaxScore" value="0" min="0" max="100" step="0.01" oninput="syncWeight(this)" />
                    </div>
                    <input type="range" min="0" max="100" step="0.01" value="0" class="form-range weight-range" oninput="syncRange(this)" />
                </td>
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById("criteriaTable").insertAdjacentHTML('beforeend', html);
        updateSummary();
    }

    function removeRow(btn) {
        if(confirm('Remove this criteria?')) {
            btn.closest("tr").remove();
            updateSummary();
        }
    }

    /* =========================
       UPDATE SUMMARY
    ========================== */
    function updateSummary() {
        const rows = document.querySelectorAll("#criteriaTable tr");
        document.getElementById("countRow").innerText = rows.length;
        document.getElementById("totalCriteria").innerText = rows.length;

        let total = 0;
        const inputs = document.querySelectorAll(".weight-input");
        inputs.forEach(inp => {
             let val = parseFloat(inp.value.replace(',', '.')); // Handle different decimal separators if needed
             if(!isNaN(val)) total += val;
        });

        // Round to avoid float errors
        total = Math.round(total * 100) / 100;

        const totalEl = document.getElementById("totalWeight");
        totalEl.innerText = total;

        const statusEl = document.getElementById("weightStatus");
        const progressEl = document.getElementById("weightProgress");

        progressEl.style.width = total + "%";

        // Always display as valid/info
        statusEl.className = "badge bg-info text-dark";
        statusEl.innerText = "Total Score";
        progressEl.className = "progress-bar bg-info";
        // Clamp visual progress to 100% to avoid overflow
        progressEl.style.width = Math.min(total, 100) + "%"; 
        
        document.getElementById("totalWeight").parentElement.className = "fw-bold text-dark mb-0";

        updateFormula();
    }

    /* =========================
       UPDATE FORMULA PREVIEW
    ========================== */
    function updateFormula() {
         const rows = document.querySelectorAll("#criteriaTable tr");
         let parts = [];
         rows.forEach((row, idx) => {
             const nameInput = row.querySelector("input[name*='CriteriaName']");
             const weightInput = row.querySelector(".weight-input");
             const name = nameInput ? nameInput.value : ("C" + (idx+1));
             const weight = weightInput ? weightInput.value : 0;
             if (weight > 0) {
                 parts.push(`${weight}% * [${name || "Untitled"}]`);
             }
         });
         
         if (parts.length === 0) {
             document.getElementById("previewFormula").innerText = "No criteria selected.";
         } else {
             document.getElementById("previewFormula").innerText = "Total Score = " + parts.join(" + ");
         }
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
        updateSummary();
    });

</script>
