@model IdeaTrack.Areas.SciTech.Models.InitiativeReportVM

<!-- HEADER -->
<div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-4">
    <div>
        <h1 class="fw-bold mb-1">Reports & Statistics</h1>
        <p class="text-muted mb-0">
            Generate detailed reports, filter data, and export statistics.
        </p>
    </div>
    <div class="d-flex gap-2">
        <form method="post" action="/SciTech/Port/ExportPdf">
            @Html.AntiForgeryToken()

            <input type="hidden" name="fromDate" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="toDate" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="status" value="@Model.Status" />
            <input type="hidden" name="keyword" value="@Model.Keyword" />

            <button type="submit" class="btn btn-outline-secondary">
                <i class="fa-solid fa-print me-1"></i>Print Report (PDF)
            </button>
        </form>


        <form method="post" action="/SciTech/Port/ExportExcel">
            @Html.AntiForgeryToken()

            <input type="hidden" name="fromDate"
                   value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="toDate"
                   value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="status" value="@Model.Status" />
            <input type="hidden" name="keyword" value="@Model.Keyword" />

            <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-download me-1"></i> Export Data
            </button>
        </form>


    </div>

</div>

<!-- ==================== DASHBOARD SECTION ==================== -->
<div class="row g-4 mb-4">
    <!-- Info Card: Open Periods -->
    <div class="col-md-3">
        <div class="card bg-gradient shadow-sm border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 small text-white-50">Đợt Nộp Đang Mở</p>
                        <h2 class="fw-bold mb-0">@ViewBag.OpenPeriodsCount</h2>
                    </div>
                    <i class="fa-solid fa-calendar-check fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Info Card: Active Categories -->
    <div class="col-md-3">
        <div class="card bg-gradient shadow-sm border-0" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 small text-white-50">Danh Mục Đang Mở</p>
                        <h2 class="fw-bold mb-0">@ViewBag.ActiveCategoriesCount</h2>
                    </div>
                    <i class="fa-solid fa-tags fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart: Audit Logs Per Day -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fa-solid fa-chart-column text-primary me-2"></i>Nhật Ký Hoạt Động (7 ngày qua)</h6>
            </div>
            <div class="card-body">
                <canvas id="auditLogsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-warning">
        <i class="fa-solid fa-triangle-exclamation me-1"></i>
        @ViewBag.ErrorMessage
    </div>
}

<!-- STATS -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <i class="fa-solid fa-folder-open text-primary fs-4"></i>
                <p class="text-muted small mb-1">Total Initiatives</p>
                <h3 class="fw-bold mb-0">@Model.TotalItems</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <i class="fa-solid fa-clock text-warning fs-4"></i>
                <p class="text-muted small mb-1">Pending</p>
                <h3 class="fw-bold mb-0">
                    @Model.Items.Count(x => x.Status == "Pending")
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <i class="fa-solid fa-circle-check text-success fs-4"></i>
                <p class="text-muted small mb-1">Approved</p>
                <h3 class="fw-bold mb-0">
                    @Model.Items.Count(x => x.Status == "Approved")
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        @{
            var approved = Model.Items.Count(x => x.Status == "Approved");
            var rate = Model.TotalItems == 0
            ? 0
            : Math.Round((double)approved / Model.TotalItems * 100, 1);
        }
        <div class="card bg-primary text-white shadow-sm">
            <div class="card-body">
                <i class="fa-solid fa-chart-pie fs-4"></i>
                <p class="small mb-1">Approval Rate</p>
                <h3 class="fw-bold mb-0">@rate%</h3>
            </div>
        </div>
    </div>
</div>

<!-- FILTER -->
<form method="get" class="row g-3 mb-4">
    <input type="hidden" name="page" value="1" />

    <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" name="fromDate" class="form-control"
               value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
    </div>

    <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" name="toDate" class="form-control"
               value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
    </div>

    <div class="col-md-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
            <option value="">All</option>
            <option value="Faculty_Approved" selected="@(Model.Status == "Faculty_Approved")">Faculty Approved</option>
            <option value="Evaluating" selected="@(Model.Status == "Evaluating")">Evaluating</option>
            <option value="Re_Evaluating" selected="@(Model.Status == "Re_Evaluating")">Re-evaluating</option>
            <option value="Pending_Final" selected="@(Model.Status == "Pending_Final")">Pending Final</option>
            <option value="Approved" selected="@(Model.Status == "Approved")">Approved</option>
            <option value="Rejected" selected="@(Model.Status == "Rejected")">Rejected</option>
            <option value="Revision_Required" selected="@(Model.Status == "Revision_Required")">Revision Required</option>
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Keyword</label>
        <input name="keyword"
               class="form-control"
               value="@Model.Keyword"
               placeholder="Code / Title" />
    </div>

    <div class="col-12 text-end">
        <button class="btn btn-primary">
            <i class="fa-solid fa-filter me-1"></i>Apply
        </button>
    </div>
</form>

<!-- TABLE -->
<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Code</th>
                    <th>Title</th>
                    <th>Year/Period</th>
                    <th>Author</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Items.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No data available
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Items)
                    {
                        <tr>
                            <td class="fw-semibold">@item.InitiativeCode</td>
                            <td>
                                <div>@item.Title</div>
                                <small class="text-muted"><i class="fa-regular fa-clock me-1"></i>@item.SubmittedDate?.ToString("dd/MM/yyyy")</small>
                            </td>
                            <td>
                                <div class="badge bg-light text-dark border">@item.AcademicYear</div>
                                <div class="small text-muted mt-1">@item.PeriodName</div>
                            </td>
                            <td>@item.ProposerName</td>
                            <td>@item.DepartmentName</td>
                            <td>
                                @{
                                    string badgeClass = "bg-secondary";
                                    string label = item.Status;

                                    switch (item.Status)
                                    {
                                        case "Approved":
                                            badgeClass = "bg-success";
                                            break;
                                        case "Rejected":
                                            badgeClass = "bg-danger";
                                            break;
                                        case "Pending":
                                            badgeClass = "bg-warning text-dark";
                                            break;
                                        case "Faculty_Approved":
                                            badgeClass = "bg-info text-white";
                                            label = "Faculty Approved";
                                            break;
                                        case "Evaluating":
                                            badgeClass = "bg-primary";
                                            break;
                                        case "Re_Evaluating":
                                            badgeClass = "bg-primary";
                                            label = "Re-evaluating";
                                            break;
                                        case "Pending_Final":
                                            badgeClass = "bg-warning text-dark";
                                            label = "Pending Final";
                                            break;
                                        case "Revision_Required":
                                            badgeClass = "bg-warning text-dark";
                                            label = "Revision Required";
                                            break;
                                        case "Draft":
                                            badgeClass = "bg-secondary";
                                            break;
                                    }
                                }
                                <span class="badge @badgeClass rounded-pill">@label</span>
                            </td>
                            <td class="text-end">
                                @{
                                    var resultStatuses = new[] { "Evaluating", "Re_Evaluating", "Pending_Final", "Approved", "Rejected" };
                                    var action = resultStatuses.Contains(item.Status) ? "Result" : "Approve";
                                    var btnClass = action == "Result" ? "btn-outline-primary" : "btn-primary";
                                    var icon = action == "Result" ? "fa-chart-bar" : "fa-eye";
                                    var title = action == "Result" ? "View Result" : "View Detail";
                                }
                                <a href="/SciTech/Port/@action/@item.Id" class="btn btn-sm @btnClass" title="@title">
                                    <i class="fas @icon"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    <div class="card-footer d-flex justify-content-between align-items-center">
        @{
            var start = (Model.CurrentPage - 1) * 5 + 1;
            var end = Math.Min(Model.CurrentPage * 5, Model.TotalItems);
        }
        <small class="text-muted">
            Showing @start-@end / @Model.TotalItems initiatives
        </small>

        <nav>
            <ul class="pagination pagination-sm mb-0">
               @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action(
                               "Index",
                               "Port",
                               new {
                                   area = "SciTech",
                                   page = i,
                                   fromDate = Model.FromDate,
                                   toDate = Model.ToDate,
                                   status = Model.Status,
                                   keyword = Model.Keyword
                               })">
                            @i
                        </a>
                    </li>
                }


            </ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var ctx = document.getElementById('auditLogsChart').getContext('2d');
            var labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ChartLabels ?? new List<string>()));
            var data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ChartData ?? new List<int>()));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng hoạt động',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        });
    </script>
}
