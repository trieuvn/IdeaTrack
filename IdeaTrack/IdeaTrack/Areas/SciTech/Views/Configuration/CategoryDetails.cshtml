@model IdeaTrack.Models.InitiativeCategory
@{
    ViewData["Title"] = "Category Details";
    var boards = ViewBag.Boards as List<IdeaTrack.Models.Board>;
    var templates = ViewBag.Templates as List<IdeaTrack.Models.EvaluationTemplate>;
    var initiativeCount = (int?)ViewBag.InitiativeCount ?? 0;
}

<style>
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    .btn-brand { background-color: #b91c1c; color: white; border: none; }
    .btn-brand:hover { background-color: #991b1b; color: white; }
    .stat-card { transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
</style>

<div class="container-fluid px-5 py-4">
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
        <a href="@Url.Action("InitiativeCategory", "Configuration", new { area = "SciTech", periodId = Model.PeriodId })" class="btn btn-outline-secondary rounded-3 me-3">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="font-display fw-bold mb-0" style="font-size: 2rem;">@Model.Name</h1>
            <p class="text-muted mb-0 small">@(Model.Description ?? "Không có mô tả")</p>
        </div>
    </div>

    @if(TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Left Column: Category Settings -->
        <div class="col-lg-8">
            <!-- General Info Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="fa-solid fa-sliders me-2 text-primary"></i>Thông tin chung
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateCategory" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Tên danh mục</label>
                                <input type="text" class="form-control bg-light" value="@Model.Name" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Kỳ sáng kiến</label>
                                <input type="text" class="form-control bg-light" value="@Model.Period?.Name" readonly />
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">
                                    <i class="fa-solid fa-users me-1 text-primary"></i>Hội đồng chấm điểm (Council)
                                </label>
                                <div class="input-group">
                                    <select name="boardId" id="boardSelect" class="form-select">
                                        <option value="">-- Chưa gán --</option>
                                        @if(boards != null)
                                        {
                                            foreach(var b in boards)
                                            {
                                                <!option value="@b.Id" @(Model.BoardId == b.Id ? "selected" : "")>@b.BoardName (@b.FiscalYear)</!option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateCouncilModal" title="Tạo nhanh Hội đồng">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">
                                    <i class="fa-solid fa-clipboard-check me-1 text-info"></i>Mẫu chấm điểm (Template)
                                </label>
                                <div class="input-group">
                                    <select name="templateId" id="templateSelect" class="form-select">
                                        <option value="">-- Chưa gán --</option>
                                        @if(templates != null)
                                        {
                                            foreach(var t in templates)
                                            {
                                                <!option value="@t.Id" @(Model.TemplateId == t.Id ? "selected" : "")>@t.TemplateName</!option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickCreateTemplateModal" title="Tạo nhanh Mẫu chấm điểm">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <button type="submit" class="btn btn-primary rounded-3 px-4">
                                <i class="fa-solid fa-save me-2"></i>Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sync Section -->
            <div class="card border-0 shadow-sm rounded-4 border-warning">
                <div class="card-header bg-warning-subtle py-3 border-bottom border-warning">
                    <h6 class="fw-bold mb-0 text-uppercase small text-warning-emphasis">
                        <i class="fa-solid fa-sync me-2"></i>Đồng bộ Sáng kiến
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Khi nhấn nút <strong>"Áp dụng"</strong>, hệ thống sẽ cập nhật tất cả sáng kiến thuộc danh mục này 
                        với <strong>Hội đồng</strong> và <strong>Mẫu chấm điểm</strong> đã chọn ở trên.
                    </p>
                    
                    <div class="alert alert-info mb-3">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Có <strong>@initiativeCount</strong> sáng kiến thuộc danh mục này sẽ được cập nhật.
                    </div>
                    
                    <form asp-action="SyncCategoryInitiatives" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn áp dụng thay đổi cho tất cả @initiativeCount sáng kiến?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-warning rounded-3 px-4">
                            <i class="fa-solid fa-bolt me-2"></i>Áp dụng cho tất cả sáng kiến
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & Reference -->
        <div class="col-lg-4">
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="card stat-card border-0 shadow-sm rounded-4 text-center p-3">
                        <div class="display-5 fw-bold text-primary">@initiativeCount</div>
                        <div class="small text-muted">Sáng kiến</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card stat-card border-0 shadow-sm rounded-4 text-center p-3">
                        <div class="display-5 fw-bold @(Model.BoardId.HasValue ? "text-success" : "text-warning")">
                            <i class="fa-solid @(Model.BoardId.HasValue ? "fa-check" : "fa-exclamation")"></i>
                        </div>
                        <div class="small text-muted">@(Model.BoardId.HasValue ? "Đã gán HĐ" : "Chưa gán HĐ")</div>
                    </div>
                </div>
            </div>

            <!-- Board Reference -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="fa-solid fa-users-rectangle me-2 text-primary"></i>Danh sách Hội đồng
                    </h6>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="ps-3 py-2 small">Tên</th>
                                <th class="py-2 small">Năm</th>
                                <th class="py-2 small text-center">SL</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if(boards != null && boards.Any())
                            {
                                foreach(var b in boards)
                                {
                                    <tr class="@(Model.BoardId == b.Id ? "table-primary" : "")">
                                        <td class="ps-3">
                                            @if(Model.BoardId == b.Id) { <i class="fa-solid fa-check text-primary me-1"></i> }
                                            <span class="small">@b.BoardName</span>
                                        </td>
                                        <td><span class="badge bg-light text-dark">@b.FiscalYear</span></td>
                                        <td class="text-center"><span class="badge bg-secondary">@(b.Members?.Count ?? 0)</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="3" class="text-center text-muted py-3">Không có hội đồng</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Create Council Modal -->
<div class="modal fade" id="quickCreateCouncilModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-primary-subtle py-3 border-0 rounded-top-4">
                <h6 class="modal-title fw-bold text-primary">
                    <i class="fa-solid fa-users-rectangle me-2"></i>Tạo nhanh Hội đồng
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Tên Hội đồng</label>
                    <input type="text" id="newCouncilName" class="form-control" 
                           value="Council @Model.Name @(Model.Period?.Name ?? "") @(Model.Period?.AcademicYear?.Name ?? "")" />
                    <small class="text-muted">Tên được gợi ý tự động theo danh mục và đợt sáng kiến</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Sao chép thành viên từ:</label>
                    <select id="cloneFromCouncil" class="form-select">
                        <option value="">-- Không sao chép (tạo rỗng) --</option>
                        @if(boards != null)
                        {
                            foreach(var b in boards)
                            {
                                <option value="@b.Id">@b.BoardName (@(b.Members?.Count ?? 0) thành viên)</option>
                            }
                        }
                    </select>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="createCouncil(false)">
                        <i class="fa-solid fa-file me-1"></i>Tạo rỗng
                    </button>
                    <button type="button" class="btn btn-primary flex-grow-1" onclick="createCouncil(true)">
                        <i class="fa-solid fa-copy me-1"></i>Clone & Tạo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Create Template Modal -->
<div class="modal fade" id="quickCreateTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-info-subtle py-3 border-0 rounded-top-4">
                <h6 class="modal-title fw-bold text-info-emphasis">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Tạo nhanh Mẫu chấm điểm
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Tên Mẫu</label>
                    <input type="text" id="newTemplateName" class="form-control" 
                           value="Mẫu @Model.Name @(Model.Period?.Name ?? "")" />
                    <small class="text-muted">Tên được gợi ý theo danh mục</small>
                </div>
                
                <div class="alert alert-info small mb-3">
                    <i class="fa-solid fa-info-circle me-1"></i>
                    Mẫu sẽ được tạo rỗng. Bạn có thể thêm các tiêu chí con sau.
                </div>
                
                <button type="button" class="btn btn-info w-100" onclick="createTemplate()">
                    <i class="fa-solid fa-plus me-1"></i>Tạo Mẫu chấm điểm
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const categoryId = @Model.Id;
    const API = {
        quickCreateCouncil: '@Url.Action("QuickCreateCouncil", "Configuration", new { area = "SciTech" })',
        quickCreateTemplate: '@Url.Action("QuickCreateTemplate", "Configuration", new { area = "SciTech" })'
    };

    function createCouncil(clone) {
        const name = document.getElementById('newCouncilName').value.trim();
        if (!name) {
            alert('Vui lòng nhập tên Hội đồng!');
            return;
        }

        const cloneFromId = clone ? document.getElementById('cloneFromCouncil').value : '';
        
        const fd = new FormData();
        fd.append('categoryId', categoryId);
        fd.append('name', name);
        if (cloneFromId) fd.append('cloneFromBoardId', cloneFromId);

        fetch(API.quickCreateCouncil, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show new council
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể tạo Hội đồng'));
                }
            })
            .catch(err => alert('Lỗi kết nối: ' + err));
    }

    function createTemplate() {
        const name = document.getElementById('newTemplateName').value.trim();
        if (!name) {
            alert('Vui lòng nhập tên Mẫu!');
            return;
        }

        const fd = new FormData();
        fd.append('categoryId', categoryId);
        fd.append('name', name);

        fetch(API.quickCreateTemplate, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show new template
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể tạo Mẫu'));
                }
            })
            .catch(err => alert('Lỗi kết nối: ' + err));
    }
</script>
}
