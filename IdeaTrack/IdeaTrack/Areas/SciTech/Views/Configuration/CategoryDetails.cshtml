@model IdeaTrack.Models.InitiativeCategory
@{
    ViewData["Title"] = "Category Details";
    var boards = ViewBag.Boards as List<IdeaTrack.Models.Board>;
    var templates = ViewBag.Templates as List<IdeaTrack.Models.EvaluationTemplate>;
    var initiativeCount = (int?)ViewBag.InitiativeCount ?? 0;
    var referenceForms = ViewBag.ReferenceForms as List<IdeaTrack.Models.ReferenceForm> ?? new List<IdeaTrack.Models.ReferenceForm>();
}

<style>
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    .btn-brand { background-color: #b91c1c; color: white; border: none; }
    .btn-brand:hover { background-color: #991b1b; color: white; }
    .stat-card { transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
</style>

<div class="container-fluid px-5 py-4">
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
        <a href="@Url.Action("InitiativeCategory", "Configuration", new { area = "SciTech", periodId = Model.PeriodId })" class="btn btn-outline-secondary rounded-3 me-3">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="font-display fw-bold mb-0" style="font-size: 2rem;">@Model.Name</h1>
            <p class="text-muted mb-0 small">@(Model.Description ?? "No description")</p>
        </div>
    </div>

    @if(TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if(TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>@TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if(TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Left Column: Category Settings -->
        <div class="col-lg-8">
            <!-- General Info Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="fa-solid fa-sliders me-2 text-primary"></i>General Information
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateCategory" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Category Name</label>
                                <input type="text" class="form-control bg-light" value="@Model.Name" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Initiative Period</label>
                                <input type="text" class="form-control bg-light" value="@Model.Period?.Name" readonly />
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">
                                    <i class="fa-solid fa-users me-1 text-primary"></i>Evaluation Council
                                </label>
                                <div class="input-group">
                                    <select name="boardId" id="boardSelect" class="form-select">
                                        <option value="">-- Not Assigned --</option>
                                        @if(boards != null)
                                        {
                                            foreach(var b in boards)
                                            {
                                                <!option value="@b.Id" @(Model.BoardId == b.Id ? "selected" : "")>@b.BoardName (@b.FiscalYear)</!option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateCouncilModal" title="Quick Create Council">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">
                                    <i class="fa-solid fa-clipboard-check me-1 text-info"></i>Scoring Template
                                </label>
                                <div class="input-group">
                                    <select name="templateId" id="templateSelect" class="form-select">
                                        <option value="">-- Not Assigned --</option>
                                        @if(templates != null)
                                        {
                                            foreach(var t in templates)
                                            {
                                                <!option value="@t.Id" @(Model.TemplateId == t.Id ? "selected" : "")>@t.TemplateName</!option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickCreateTemplateModal" title="Quick Create Template">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <button type="submit" class="btn btn-primary rounded-3 px-4">
                                <i class="fa-solid fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reference Forms Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="fa-solid fa-file-alt me-2 text-success"></i>Reference Forms
                    </h6>
                    <button type="button" class="btn btn-sm btn-success rounded-3" data-bs-toggle="modal" data-bs-target="#uploadFormModal">
                        <i class="fa-solid fa-upload me-1"></i>Upload
                    </button>
                </div>
                <div class="card-body">
                    @if(referenceForms.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach(var form in referenceForms)
                            {
                                var fileIcon = form.FileType switch
                                {
                                    ".pdf" => "fa-file-pdf text-danger",
                                    ".docx" or ".doc" => "fa-file-word text-primary",
                                    ".xlsx" or ".xls" => "fa-file-excel text-success",
                                    ".pptx" or ".ppt" => "fa-file-powerpoint text-warning",
                                    _ => "fa-file text-secondary"
                                };
                                
                                <div class="list-group-item d-flex align-items-center justify-content-between px-0">
                                    <div class="d-flex align-items-center">
                                        <i class="fa-solid @fileIcon me-3" style="font-size: 24px;"></i>
                                        <div>
                                            <div class="fw-medium">@form.FormName</div>
                                            <div class="small text-muted">@form.FileName â€¢ @form.UploadedAt.ToString("dd/MM/yyyy HH:mm")</div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="@form.FileUrl" download class="btn btn-sm btn-outline-primary" title="Download">
                                            <i class="fa-solid fa-download"></i>
                                        </a>
                                        <form asp-action="DeleteReferenceForm" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@form.Id" />
                                            <input type="hidden" name="categoryId" value="@Model.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="fa-solid fa-folder-open mb-3" style="font-size: 48px;"></i>
                            <p class="mb-0">No reference forms yet. Click "Upload" to add one.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Sync Section -->
            <div class="card border-0 shadow-sm rounded-4 border-warning">
                <div class="card-header bg-warning-subtle py-3 border-bottom border-warning">
                    <h6 class="fw-bold mb-0 text-uppercase small text-warning-emphasis">
                        <i class="fa-solid fa-sync me-2"></i>Sync Initiatives
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        When you click <strong>"Sync"</strong>, the system will:
                    </p>
                    <ul class="text-muted small mb-3">
                        <li>Find all initiatives with <strong>Evaluating</strong>, <strong>Re_Evaluating</strong> or <strong>Approved</strong> status</li>
                        <li>Close current evaluation round and create a new round</li>
                        <li>Assign initiatives to the <strong>new Council</strong> selected above</li>
                        <li>Set status to <strong>Re_Evaluating</strong> for the new council to evaluate</li>
                    </ul>
                    
                    <div class="alert alert-warning small mb-3">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> Approved initiatives will also be re-evaluated by the new council.
                    </div>
                    
                    <form asp-action="SyncCategoryInitiatives" method="post" onsubmit="return confirm('Confirm sync? All initiatives (including Approved) will be transferred to the new Council for re-evaluation.');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-warning rounded-3 px-4">
                            <i class="fa-solid fa-bolt me-2"></i>Sync to New Council
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & Reference -->
        <div class="col-lg-4">
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="card stat-card border-0 shadow-sm rounded-4 text-center p-3">
                        <div class="display-5 fw-bold text-primary">@initiativeCount</div>
                        <div class="small text-muted">Initiatives</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card stat-card border-0 shadow-sm rounded-4 text-center p-3">
                        <div class="display-5 fw-bold @(Model.BoardId.HasValue ? "text-success" : "text-warning")">
                            <i class="fa-solid @(Model.BoardId.HasValue ? "fa-check" : "fa-exclamation")"></i>
                        </div>
                        <div class="small text-muted">@(Model.BoardId.HasValue ? "Council Assigned" : "No Council")</div>
                    </div>
                </div>
            </div>

            <!-- Board Reference -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="fa-solid fa-users-rectangle me-2 text-primary"></i>Council List
                    </h6>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="ps-3 py-2 small">Name</th>
                                <th class="py-2 small">Year</th>
                                <th class="py-2 small text-center">Members</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if(boards != null && boards.Any())
                            {
                                foreach(var b in boards)
                                {
                                    <tr class="@(Model.BoardId == b.Id ? "table-primary" : "")">
                                        <td class="ps-3">
                                            @if(Model.BoardId == b.Id) { <i class="fa-solid fa-check text-primary me-1"></i> }
                                            <span class="small">@b.BoardName</span>
                                        </td>
                                        <td><span class="badge bg-light text-dark">@b.FiscalYear</span></td>
                                        <td class="text-center"><span class="badge bg-secondary">@(b.Members?.Count ?? 0)</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="3" class="text-center text-muted py-3">No councils available</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Create Council Modal -->
<div class="modal fade" id="quickCreateCouncilModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-primary-subtle py-3 border-0 rounded-top-4">
                <h6 class="modal-title fw-bold text-primary">
                    <i class="fa-solid fa-users-rectangle me-2"></i>Quick Create Council
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Council Name</label>
                    <input type="text" id="newCouncilName" class="form-control" 
                           value="Council @Model.Name @(Model.Period?.Name ?? "") @(Model.Period?.AcademicYear?.Name ?? "")" />
                    <small class="text-muted">Name is auto-suggested based on category and period</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Clone Members From:</label>
                    <select id="cloneFromCouncil" class="form-select">
                        <option value="">-- Don't Clone (Create Empty) --</option>
                        @if(boards != null)
                        {
                            foreach(var b in boards)
                            {
                                <option value="@b.Id">@b.BoardName (@(b.Members?.Count ?? 0) members)</option>
                            }
                        }
                    </select>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="createCouncil(false)">
                        <i class="fa-solid fa-file me-1"></i>Create Empty
                    </button>
                    <button type="button" class="btn btn-primary flex-grow-1" onclick="createCouncil(true)">
                        <i class="fa-solid fa-copy me-1"></i>Clone & Create
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Create Template Modal -->
<div class="modal fade" id="quickCreateTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-info-subtle py-3 border-0 rounded-top-4">
                <h6 class="modal-title fw-bold text-info-emphasis">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Quick Create Template
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Template Name</label>
                    <input type="text" id="newTemplateName" class="form-control" 
                           value="Template @Model.Name @(Model.Period?.Name ?? "")" />
                    <small class="text-muted">Name is suggested based on category</small>
                </div>
                
                <div class="alert alert-info small mb-3">
                    <i class="fa-solid fa-info-circle me-1"></i>
                    Template will be created empty. You can add criteria later.
                </div>
                
                <button type="button" class="btn btn-info w-100" onclick="createTemplate()">
                    <i class="fa-solid fa-plus me-1"></i>Create Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Reference Form Modal -->
<div class="modal fade" id="uploadFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-success-subtle py-3 border-0 rounded-top-4">
                <h6 class="modal-title fw-bold text-success-emphasis">
                    <i class="fa-solid fa-upload me-2"></i>Upload Reference Form
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="UploadReferenceForm" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="categoryId" value="@Model.Id" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Display Name</label>
                        <input type="text" name="formName" class="form-control" required
                               placeholder="E.g., Initiative Proposal Form" />
                        <small class="text-muted">Display name for users (not the file name)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Select File</label>
                        <input type="file" name="file" class="form-control" required
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" />
                        <small class="text-muted">Supported: PDF, Word, Excel, PowerPoint</small>
                    </div>
                    
                    <div class="alert alert-info small mb-0">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        File will be saved and can be downloaded by all categories in the same period.
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">
                        <i class="fa-solid fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success rounded-3">
                        <i class="fa-solid fa-upload me-1"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const categoryId = @Model.Id;
    const API = {
        quickCreateCouncil: '@Url.Action("QuickCreateCouncil", "Configuration", new { area = "SciTech" })',
        quickCreateTemplate: '@Url.Action("QuickCreateTemplate", "Configuration", new { area = "SciTech" })'
    };

    function createCouncil(clone) {
        const name = document.getElementById('newCouncilName').value.trim();
        if (!name) {
            alert('Please enter a Council name!');
            return;
        }

        const cloneFromId = clone ? document.getElementById('cloneFromCouncil').value : '';
        
        const fd = new FormData();
        fd.append('categoryId', categoryId);
        fd.append('name', name);
        if (cloneFromId) fd.append('cloneFromBoardId', cloneFromId);

        fetch(API.quickCreateCouncil, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show new council
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Could not create Council'));
                }
            })
            .catch(err => alert('Connection error: ' + err));
    }

    function createTemplate() {
        const name = document.getElementById('newTemplateName').value.trim();
        if (!name) {
            alert('Please enter a Template name!');
            return;
        }

        const fd = new FormData();
        fd.append('categoryId', categoryId);
        fd.append('name', name);

        fetch(API.quickCreateTemplate, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show new template
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Could not create Template'));
                }
            })
            .catch(err => alert('Connection error: ' + err));
    }
</script>
}
