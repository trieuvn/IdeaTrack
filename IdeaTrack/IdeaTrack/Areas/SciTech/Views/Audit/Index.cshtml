@model List<IdeaTrack.Services.AuditLogEntry>
@{
    ViewData["Title"] = "System Audit Log";
    Layout = "~/Areas/SciTech/Views/Shared/_LayoutSciTech.cshtml";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-history text-primary me-2"></i>System Audit Log
        </h2>
        <a asp-action="Statistics" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-1"></i>Statistics
        </a>
    </div>

    <!-- Multi-Filter DataTable -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0"><i class="fas fa-filter me-2 text-primary"></i>Nhật Ký Hệ Thống (Multi-Filter)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="multi-filter-select" class="display table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Người Dùng</th>
                            <th>Hành Động</th>
                            <th>Bảng</th>
                            <th>ID</th>
                            <th>Thời Gian</th>
                            <th>IP</th>
                            <th>Chi Tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model)
                        {
                            <tr>
                                <td>@log.UserName</td>
                                <td>
                                    <span class="badge @GetActionBadgeClass(log.Action)">@log.Action</span>
                                </td>
                                <td><code>@log.TargetTable</code></td>
                                <td>@log.TargetId</td>
                                <td data-order="@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")">
                                    @log.Timestamp.ToString("dd/MM/yyyy HH:mm")
                                </td>
                                <td><small class="text-muted">@log.IpAddress</small></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.Details))
                                    {
                                        <a asp-action="Details" asp-route-id="@log.Id" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Người Dùng</th>
                            <th>Hành Động</th>
                            <th>Bảng</th>
                            <th>ID</th>
                            <th>Thời Gian</th>
                            <th>IP</th>
                            <th>Chi Tiết</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        $(document).ready(function() {
            $('#multi-filter-select').DataTable({
                pageLength: 15,
                order: [[4, 'desc']], // Sort by Timestamp descending
                initComplete: function() {
                    this.api()
                        .columns([0, 1, 2]) // Only add filters to User, Action, Table columns
                        .every(function() {
                            var column = this;
                            var select = $('<select class="form-select form-select-sm"><option value="">Tất cả</option></select>')
                                .appendTo($(column.footer()).empty())
                                .on('change', function() {
                                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column.search(val ? '^' + val + '$' : '', true, false).draw();
                                });

                            column.data()
                                .unique()
                                .sort()
                                .each(function(d, j) {
                                    // Extract text content for badge columns
                                    var text = $('<div>').html(d).text().trim();
                                    if (text) {
                                        select.append('<option value="' + text + '">' + text + '</option>');
                                    }
                                });
                        });
                },
                language: {
                    search: "Tìm kiếm:",
                    lengthMenu: "Hiển thị _MENU_ dòng",
                    info: "Đang hiển thị _START_ đến _END_ của _TOTAL_ mục",
                    infoEmpty: "Không có dữ liệu",
                    infoFiltered: "(lọc từ _MAX_ mục)",
                    paginate: {
                        first: "Đầu",
                        last: "Cuối",
                        next: "Sau",
                        previous: "Trước"
                    },
                    emptyTable: "Không có dữ liệu trong bảng"
                }
            });
        });
    </script>
}

@functions {
    string GetActionBadgeClass(string action)
    {
        return action.ToLower() switch
        {
            "create" => "bg-success",
            "update" => "bg-primary",
            "delete" => "bg-danger",
            "approve" => "bg-info",
            "reject" => "bg-warning text-dark",
            "submit" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
